name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Compile and package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out | Out-Null

          $runtimeDir = 'out/runtime-sea-portable'
          $prodDir = 'out/prod-deps'
          $blobPath = 'out/sea-prep.blob'
          $seaConfigPath = 'out/sea-config.json'
          $seaEntryPath = 'out/sea-entry.cjs'
          $exeName = 'insta-launcher.exe'
          $exePath = "$runtimeDir/$exeName"

          if (Test-Path $runtimeDir) {
            Remove-Item $runtimeDir -Recurse -Force
          }

          if (Test-Path $prodDir) {
            Remove-Item $prodDir -Recurse -Force
          }

          New-Item -ItemType Directory -Force -Path $runtimeDir | Out-Null
          New-Item -ItemType Directory -Force -Path $prodDir | Out-Null

          Copy-Item package.json "$prodDir/package.json" -Force
          Copy-Item package-lock.json "$prodDir/package-lock.json" -Force

          Push-Location $prodDir
          $env:PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = '1'
          npm ci --omit=dev
          Pop-Location

          Copy-Item "$prodDir/node_modules" "$runtimeDir/node_modules" -Recurse -Force
          Copy-Item dist "$runtimeDir/dist" -Recurse -Force
          Copy-Item package.json "$runtimeDir/package.json" -Force

          if (Test-Path data) {
            Copy-Item data "$runtimeDir/data" -Recurse -Force
          }

          Set-Content -Path $seaEntryPath -Value "const path = require('path'); const { createRequire } = require('module'); const appRequire = createRequire(path.join(path.dirname(process.execPath), 'package.json')); appRequire('./dist/index.js');"

          $seaConfig = @{
            main = $seaEntryPath
            output = $blobPath
            disableExperimentalSEAWarning = $true
            useSnapshot = $false
            useCodeCache = $false
          } | ConvertTo-Json -Compress

          Set-Content -Path $seaConfigPath -Value $seaConfig

          node --experimental-sea-config $seaConfigPath

          $nodeExe = (Get-Command node).Source
          Copy-Item $nodeExe $exePath -Force

          $signTool = Get-Command signtool -ErrorAction SilentlyContinue
          if ($signTool) {
            try {
              signtool remove /s $exePath
            } catch {
            }
          }

          npx postject $exePath NODE_SEA_BLOB $blobPath --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2 --overwrite

          Set-Content -Path "$runtimeDir/start.cmd" -Value "@echo off`r`n`"%~dp0$exeName`""

          if (Test-Path $blobPath) {
            Remove-Item $blobPath -Force
          }

          Compress-Archive -Path "$runtimeDir/*" -DestinationPath 'out/insta-launcher-sea-portable.zip' -Force

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          target_commitish: ${{ github.sha }}
          name: ${{ github.ref_name }}
          body: |
            Build de distribuicao com Node SEA focado em compatibilidade completa com Playwright.

            Conteudo do pacote:
            - insta-launcher.exe (Node SEA)
            - node_modules de producao completos
            - dist compilado
            - start.cmd para execucao
          files: out/insta-launcher-sea-portable.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
